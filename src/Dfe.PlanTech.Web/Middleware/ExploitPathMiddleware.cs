using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;

namespace Dfe.PlanTech.Web.Middleware;

public sealed class ExploitPathMiddleware(RequestDelegate next, ILogger<ExploitPathMiddleware> logger)
{
    public async Task Invoke(HttpContext context)
    {
        var path = context.Request.Path.Value ?? string.Empty;

        var isAdmin = path.Equals("/admin", StringComparison.OrdinalIgnoreCase);
        var isPhp = path.EndsWith(".php", StringComparison.OrdinalIgnoreCase);

        if (isAdmin || isPhp)
        {
            context.Response.StatusCode = StatusCodes.Status404NotFound;

            logger.LogInformation("Blocked bot exploit path: {Path}", path);
            return;
        }

        await next(context);
    }
}
