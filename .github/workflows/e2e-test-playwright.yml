name: Run Playwright E2E Tests

on:
    workflow_dispatch:
        inputs:
            environment:
                description: Which db environment to run the tests on
                required: true
                type: choice
                options: [ 'Dev', 'Tst' ]
                default: 'Dev'

concurrency:
    group: "${{ github.workflow }}"
    cancel-in-progress: false

env:
    DOTNET_VERSION: ${{ vars.DOTNET_VERSION }}

jobs:
  run-tests:
        permissions:
          id-token: write
          contents: read
        name: Run Playwright + Cucumber Tests
        runs-on: ubuntu-22.04
        env:
            PROJECT_PATH: ./src/Dfe.PlanTech.Web/Dfe.PlanTech.Web.csproj
            KEYVAULT_NAME: ${{ secrets.AZ_ENVIRONMENT }}${{ secrets.DFE_PROJECT_NAME }}-kv
            RESOURCE_GROUP: ${{ secrets.AZ_ENVIRONMENT }}${{ secrets.DFE_PROJECT_NAME }}
            SQL_IP_NAME: e2e-tests-pr

        steps:
            - name: Start Azure SQL Edge and seed DB
              shell: bash
              working-directory: ./tests/Dfe.PlanTech.Web.SeedTestData/scripts
              env:
                SA_PASSWORD: ${{ secrets.E2E_SQL_SA_PASSWORD }}
              timeout-minutes: 5
              run: |
                set -euo pipefail
                ls -la
                echo "---- first lines of script ----"
                head -n 30 ./setup-ci.sh
                chmod +x ./setup-ci.sh
                ./setup-ci.sh azuresqledge "$SA_PASSWORD"

            - name: Debug SQL Edge
              if: failure()
              run: |
                docker ps -a
                docker logs azuresqledge || true
                docker exec azuresqledge ls -la /opt || true
                docker exec azuresqledge which /opt/mssql-tools/bin/sqlcmd || true                

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Clear NuGet Cache
              shell: bash
              run: dotnet nuget locals all --clear

            - name: Install dependencies
              shell: bash
              run: dotnet restore ${{ env.PROJECT_PATH }}

            - name: Build project
              shell: bash
              run: dotnet publish ./src/Dfe.PlanTech.Web/Dfe.PlanTech.Web.csproj --configuration Release --no-restore --output ./build

            - name: Create overwrite json file
              shell: bash
              working-directory: ./build
              run: |
                echo "{ \"DfeSignIn\": { \"FrontDoorUrl\": \"https://localhost:8081\"}}" > overrides.json

            - name: Get workflow IP address
              id: whats-my-ip
              uses: ./.github/actions/whats-my-ip-address

            - name: Add Azure firewall rules
              uses: ./.github/actions/azure-ip-whitelist
              with:
                  ip_address: ${{ steps.whats-my-ip.outputs.ip }}
                  verb: "add"
                  az_keyvault_name: ${{ env.KEYVAULT_NAME }}
                  az_ip_name: ${{ env.SQL_IP_NAME }}
                  az_resource_group: ${{ env.RESOURCE_GROUP }}
                  az_sql_database_server_name: ${{ env.RESOURCE_GROUP }}

            - name: Run Web App (E2E, local SQL Edge)
              shell: bash
              working-directory: ./build
              env:
                SA_PASSWORD: ${{ secrets.E2E_SQL_SA_PASSWORD }}
              run: |
                export ASPNETCORE_ENVIRONMENT=E2E
                export KeyVaultName=${{ env.KEYVAULT_NAME }}
                export Kestrel__Endpoints__Https__Url=https://*:8081
                export DfeSignIn__FrontDoorUrl=https://localhost:8081
                export GTM__Id=gtm_id
                export GTM__SiteVerificationId=testing_site_verification_id
                export AutomatedTesting__Contentful__Tag=e2e
                export AutomatedTesting__Contentful__IncludeTaggedContent=true
                export ConnectionStrings__Database="Server=tcp:localhost,1433;Persist Security Info=False;User ID=sa;Password=$SA_PASSWORD;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=True;Connection Timeout=30;Max Pool Size=1000;Database=plantech-mock-db"
                dotnet ./Dfe.PlanTech.Web.dll &

            - name: Install Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install NPM dependencies
              working-directory: ./tests/Dfe.PlanTech.Web.E2ETests.Beta/
              run: npm ci

            - name: Install Playwright browsers
              working-directory: ./tests/Dfe.PlanTech.Web.E2ETests.Beta/
              run: npx playwright install --with-deps

            - name: Setup session storage (login)
              working-directory: ./tests/Dfe.PlanTech.Web.E2ETests.Beta/
              run: npx ts-node login.setup.ts

            - name: Run Playwright + Cucumber tests (with recording)
              working-directory: ./tests/Dfe.PlanTech.Web.E2ETests.Beta/
              env:
                  URL: https://localhost:8081
                  DSI_SCHOOL_EMAIL: ${{ secrets.DSI_SCHOOL_EMAIL }}
                  DSI_SCHOOL_PASSWORD: ${{ secrets.DSI_SCHOOL_PASSWORD }}
                  DSI_SCHOOL_ESTABLISHMENT_REF: 00000018
                  DSI_MAT_EMAIL: ${{ secrets.DSI_MAT_EMAIL }}
                  DSI_MAT_PASSWORD: ${{ secrets.DSI_MAT_PASSWORD }}
                  DSI_MAT_SCHOOL_ESTABLISHMENT_REF: 00000005
                  DSI_NOORG_EMAIL: ${{ secrets.DSI_NOORG_EMAIL }}
                  DSI_NOORG_PASSWORD: ${{ secrets.DSI_NOORG_PASSWORD }}
                  DB_USER: sa
                  DB_PASSWORD: ${{ secrets.E2E_SQL_SA_PASSWORD }}
                  DB_PORT: 1433
                  DB_DATABASE: plantech-mock-db
                  DB_ENCRYPT: true
                  DB_TRUST_SERVER_CERTIFICATE: true
                  HEADLESS: false
              run: npm run test:login && npm run test:record

            - name: Generate HTML report
              if: always()
              working-directory: ./tests/Dfe.PlanTech.Web.E2ETests.Beta/
              run: npm run report

            - name: Upload HTML report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: cucumber-html-report
                  path: ./tests/Dfe.PlanTech.Web.E2ETests.Beta/reports/
                  if-no-files-found: warn

            - name: Upload Playwright screenshots
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-screenshots
                  path: ./tests/Dfe.PlanTech.Web.E2ETests.Beta/screenshots/
                  if-no-files-found: ignore

            - name: Upload Playwright videos
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-videos
                  path: ./tests/Dfe.PlanTech.Web.E2ETests.Beta/videos/
                  if-no-files-found: ignore

            - name: Upload Playwright traces
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-traces
                  path: ./tests/Dfe.PlanTech.Web.E2ETests.Beta/traces/
                  if-no-files-found: ignore

            - name: Stop & remove SQL Edge container
              if: always()
              shell: bash
              run: |
                docker ps -a
                docker logs azuresqledge || true
                docker stop azuresqledge || true
                docker rm azuresqledge || true



