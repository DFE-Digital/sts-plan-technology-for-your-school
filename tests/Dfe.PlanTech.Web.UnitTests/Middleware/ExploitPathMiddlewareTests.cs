using Dfe.PlanTech.Web.Middleware;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using NSubstitute;

namespace Dfe.PlanTech.Web.UnitTests.Middleware;

public class ExploitPathMiddlewareTests
{
    private static async Task Next(HttpContext context)
    {
        context.Response.StatusCode = StatusCodes.Status200OK;
        await context.Response.WriteAsync("Response Body");
    }

    [Fact]
    public async Task Admin_Path_Should_Return_404()
    {
        var logger = Substitute.For<ILogger<ExploitPathMiddleware>>();

        var context = new DefaultHttpContext()
        {
            Request = { Path = "/admin" },
            Response = { Body = new MemoryStream() },
        };

        var middleware = new ExploitPathMiddleware(Next, logger);
        await middleware.Invoke(context);

        Assert.Equal(404, context.Response.StatusCode);
        Assert.Equal(0, context.Response.Body.Length);

        logger.Received(1).Log(
            LogLevel.Information,
            Arg.Any<EventId>(),
            Arg.Any<object>(),
            Arg.Any<Exception?>(),
            Arg.Any<Func<object, Exception?, string>>());
    }

    [Fact]
    public async Task Php_Path_Should_Return_404()
    {
        var logger = Substitute.For<ILogger<ExploitPathMiddleware>>();

        var context = new DefaultHttpContext()
        {
            Request = { Path = "/login.php" },
            Response = { Body = new MemoryStream() },
        };

        var middleware = new ExploitPathMiddleware(Next, logger);
        await middleware.Invoke(context);

        Assert.Equal(404, context.Response.StatusCode);
        Assert.Equal(0, context.Response.Body.Length);

        logger.Received(1).Log(
            LogLevel.Information,
            Arg.Any<EventId>(),
            Arg.Any<object>(),
            Arg.Any<Exception?>(),
            Arg.Any<Func<object, Exception?, string>>());
    }

    [Fact]
    public async Task Non_Exploit_Path_Should_Call_Next()
    {
        var logger = Substitute.For<ILogger<ExploitPathMiddleware>>();

        var context = new DefaultHttpContext()
        {
            Request = { Path = "/valid-route" },
            Response = { Body = new MemoryStream() },
        };

        var middleware = new ExploitPathMiddleware(Next, logger);
        await middleware.Invoke(context);

        Assert.Equal(200, context.Response.StatusCode);
        Assert.NotEqual(0, context.Response.Body.Length);

        context.Response.Body.Seek(0, SeekOrigin.Begin);
        var response = await new StreamReader(context.Response.Body).ReadToEndAsync();

        Assert.Equal("Response Body", response);

        logger.DidNotReceive().Log(
            LogLevel.Information,
            Arg.Any<EventId>(),
            Arg.Any<object>(),
            Arg.Any<Exception?>(),
            Arg.Any<Func<object, Exception?, string>>());
    }
}
